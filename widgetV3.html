<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ReputeFeed Widget</title>
<link href="https://fonts.googleapis.com/css2?family=Questrial:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  html,body{margin:0;padding:0;background:transparent}
  #rf-widget, #rf-widget * { box-sizing:border-box; }
  #rf-widget{
    --rf-font:'Questrial',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    font-family:var(--rf-font);
    width:100%; max-width:420px; margin:0 auto; padding:14px;
    background:transparent; color:var(--text); overflow:hidden;
    --bg:#0f141c; --text:#e8eef7; --muted:#9aa4b2; --line:rgba(255,255,255,.08);
    --acc-1:#ff9a1f; --acc-2:#ffb44d; --acc-3:#ffd180; --acc-4:#ffe6b3;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.22);
  }
  #rf-widget.theme-gold     { --bg:#0f141c; --text:#e8eef7; --muted:#9aa4b2; --line:rgba(255,255,255,.08);
                              --acc-1:#ff9a1f; --acc-2:#ffb44d; --acc-3:#ffd180; --acc-4:#ffe6b3; }
  #rf-widget.theme-slate    { --bg:#0e1219; --text:#e8eef7; --muted:#c8ceda; --line:rgba(255,255,255,.08);
                              --acc-1:#c8ceda; --acc-2:#eef1f7; --acc-3:#aab4c6; --acc-4:#ffffff; }
  #rf-widget.theme-emerald  { --bg:#0e1411; --text:#e8eef7; --muted:#9fb2a9; --line:rgba(255,255,255,.08);
                              --acc-1:#0fa66b; --acc-2:#12b886; --acc-3:#5ee8bf; --acc-4:#b0ffe2; }
  #rf-widget.theme-amethyst { --bg:#0f0e17; --text:#e8eef7; --muted:#c9b8ff; --line:rgba(255,255,255,.08);
                              --acc-1:#6e59f2; --acc-2:#8b7cff; --acc-3:#c9b8ff; --acc-4:#ffca6a; }
  #rf-widget.theme-frost    { --bg:#f6f7fb; --text:#111827; --muted:#111827; --line:rgba(16,24,40,.18);
                              --acc-1:#5aa3ff; --acc-2:#95c8ff; --acc-3:#e5eaf3; --acc-4:#ffd37a; }
  #rf-widget.theme-copper   { --bg:#111318; --text:#e9edf5; --muted:#aeb7c7; --line:rgba(255,255,255,.08);
                              --acc-1:#c97a2b; --acc-2:#e09a54; --acc-3:#f2bf8a; --acc-4:#ffe0b8; }
  #rf-widget.theme-sapphire { --bg:#0b0f1a; --text:#eaf1ff; --muted:#b8c4dd; --line:rgba(255,255,255,.08);
                              --acc-1:#3a7bff; --acc-2:#6aa3ff; --acc-3:#9cc2ff; --acc-4:#d2e2ff; }
  #rf-widget.theme-coral    { --bg:#121016; --text:#f7ecf0; --muted:#d3c2c9; --line:rgba(255,255,255,.08);
                              --acc-1:#ff6f61; --acc-2:#ff8c6b; --acc-3:#ffb199; --acc-4:#ffd4c5; }
  #rf-widget.theme-graphite { --bg:#0f1216; --text:#eef2f7; --muted:#c7ced9; --line:rgba(255,255,255,.10);
                              --acc-1:#aeb6c4; --acc-2:#c4ccd8; --acc-3:#dde3ec; --acc-4:#ffffff; }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent 18%), var(--bg);
    border:1px solid var(--line); border-radius:var(--radius); padding:16px 14px; box-shadow:var(--shadow);
  }
  .title{ margin:0 0 8px; text-align:center; color:var(--muted); font-weight:800; }

  .stars{ display:flex; justify-content:center; gap:8px; margin:8px 0 12px; }
  .star{
    width:36px; height:36px; border:none; background:none; padding:0; line-height:0; cursor:pointer;
    transform:translateZ(0); transition:transform .12s ease; filter:drop-shadow(0 4px 14px rgba(0,0,0,.18));
    -webkit-appearance:none; appearance:none; outline:none; -webkit-tap-highlight-color:transparent; /* iOS fix */
  }
  .star:hover{ transform:scale(1.12); }
  .star:active{ transform:scale(.96); }
  .star svg{ display:block; width:100%; height:100%; fill:url(#rf-disabled); stroke:rgba(255,255,255,.18); stroke-width:1; }
  .star.active svg, .star.preview svg{ fill:url(#rf-accent); stroke:transparent; }
  #rf-widget.theme-frost .star svg{ stroke:#000; stroke-width:1.2; }

  /* ensure clicks reach the button, not the SVG */
  #rf-widget .star svg, #rf-widget .star svg * { pointer-events: none; }

  @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.18)} 100%{transform:scale(1)} }
  .star.pop{ animation:pop .22s ease; }

  /* Animation toggles */
  #rf-widget.rf-no-star-anim .star{
    transition:none;
  }
  #rf-widget.rf-no-star-anim .star:hover,
  #rf-widget.rf-no-star-anim .star:active{
    transform:none;
  }
  #rf-widget.rf-no-star-anim .star.pop{
    animation:none;
  }
  #rf-widget.rf-no-cta-anim .cta{
    transition:none;
  }
  #rf-widget.rf-no-cta-anim .cta:hover{
    transform:none;
    box-shadow:0 2px 8px rgba(0,0,0,.35), 0 12px 28px rgba(0,0,0,.20);
  }
  #rf-widget.rf-no-cta-anim .cta:active{
    transform:none;
  }

  .field{ margin:10px 0 }
  .label{ display:block; color:var(--text); opacity:.9; font-size:.95rem; margin-bottom:6px; }
  textarea, input[type="email"]{
    display:block; width:100%;
    border:1px solid var(--line); border-radius:12px; background:#0b111a; color:#e8eef7;
    padding:10px 12px; font-size:.98rem; outline:none; resize:none; line-height:1.4;
    font-family:var(--rf-font) !important;
  }
  textarea:focus, input:focus{ border-color:rgba(255,255,255,.22); }

  .helper{ display:block; margin-top:6px; color:var(--muted); font-size:.85rem; }
  .consent{ display:flex; gap:8px; align-items:flex-start; color:var(--muted); font-size:.9rem; margin:14px 0 10px }
  .consent input{ margin-top:3px }

  .cta{
    width:100%; padding:.9rem 1.1rem; border-radius:14px; border:0; cursor:pointer;
    background:linear-gradient(135deg, var(--acc-1), var(--acc-2), var(--acc-3), var(--acc-4));
    color:#221607; font-weight:800; letter-spacing:.2px; font-size:1rem;
    box-shadow:0 2px 8px rgba(0,0,0,.35), 0 12px 28px rgba(0,0,0,.20);
    transition:transform .15s ease, box-shadow .15s ease, opacity .2s ease; margin-top:12px;
  }
  .cta:hover{ transform:translateY(-2px); box-shadow:0 4px 14px rgba(0,0,0,.45), 0 16px 36px rgba(0,0,0,.26); }
  .cta:active{ transform:translateY(0); }
  .cta:disabled{ opacity:.6; cursor:default; transform:none; }

  .msg{ margin-top:8px; font-size:.92rem; color:var(--muted); min-height:1.2em; }
  .hide{ display:none !important }
  .thanks{ text-align:center; padding:24px 8px }
  .thanks h3{ margin:0 0 8px; font-size:1.1rem; font-weight:800;
    background:linear-gradient(135deg, var(--acc-1), var(--acc-2), var(--acc-3), var(--acc-4));
    -webkit-background-clip:text; background-clip:text; color:transparent; }
</style>
</head>
<body>
  <div id="rf-widget">
    <!-- Gradients -->
    <svg width="0" height="0" aria-hidden="true" focusable="false" style="position:absolute;">
      <defs>
        <linearGradient id="rf-accent" x1="0%" y1="0%" x2="100%">
          <stop offset="0%"   style="stop-color: var(--acc-1);" />
          <stop offset="35%"  style="stop-color: var(--acc-2);" />
          <stop offset="65%"  style="stop-color: var(--acc-3);" />
          <stop offset="100%" style="stop-color: var(--acc-4);" />
        </linearGradient>
        <linearGradient id="rf-disabled" x1="0%" y1="0%" x2="100%">
          <stop offset="0%"   style="stop-color: #1a2230;" />
          <stop offset="100%" style="stop-color: #1a2230;" />
        </linearGradient>
      </defs>
    </svg>

    <div class="card" id="rf-form">
      <p class="title">Rate your experience</p>

      <div class="stars" id="rf-stars" role="radiogroup" aria-label="Star rating (1 to 5)">
        <button class="star" data-v="1" aria-label="1 star"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.95 6.35 6.99.64-5.28 4.57 1.6 6.84L12 17.77 5.74 20.4l1.6-6.84L2.06 9 9.05 8.35 12 2z"/></svg></button>
        <button class="star" data-v="2" aria-label="2 stars"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.95 6.35 6.99.64-5.28 4.57 1.6 6.84L12 17.77 5.74 20.4l1.6-6.84L2.06 9 9.05 8.35 12 2z"/></svg></button>
        <button class="star" data-v="3" aria-label="3 stars"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.95 6.35 6.99.64-5.28 4.57 1.6 6.84L12 17.77 5.74 20.4l1.6-6.84L2.06 9 9.05 8.35 12 2z"/></svg></button>
        <button class="star" data-v="4" aria-label="4 stars"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.95 6.35 6.99.64-5.28 4.57 1.6 6.84L12 17.77 5.74 20.4l1.6-6.84L2.06 9 9.05 8.35 12 2z"/></svg></button>
        <button class="star" data-v="5" aria-label="5 stars"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.95 6.35 6.99.64-5.28 4.57 1.6 6.84L12 17.77 5.74 20.4l1.6-6.84L2.06 9 9.05 8.35 12 2z"/></svg></button>
      </div>

      <div class="field">
        <label class="label" for="rf-text">Tell us more (optional)</label>
        <textarea id="rf-text" rows="3" maxlength="500" placeholder="Two lines about your experience…"></textarea>
        <small class="helper">Max 500 characters.</small>
      </div>

      <div class="field">
        <label class="label" for="rf-email">Email (optional, for a follow-up if needed)</label>
        <input id="rf-email" type="email" placeholder="you@domain.com" inputmode="email" autocomplete="email" />
      </div>

      <label class="consent">
        <input id="rf-consent" type="checkbox" required />
        <span>I consent to processing this feedback and understand it may be used to improve services.</span>
      </label>

      <input type="text" id="rf-website" style="position:absolute;left:-9999px;opacity:0;height:0;width:0" tabindex="-1" aria-hidden="true" autocomplete="off" />

      <button class="cta" id="rf-send">Send feedback</button>
      <p class="msg" id="rf-msg" role="status" aria-live="polite"></p>
    </div>

    <div class="card thanks hide" id="rf-thanks" role="status" aria-live="polite">
      <h3>Thanks for your feedback!</h3>
      <p>Your response was received.</p>
    </div>
  </div>

<script>
(function(){
  var root = document.getElementById('rf-widget');

  // Global customization/state toggles
  var TEXT_MAX_LENGTH       = 500;
  var ERROR_MESSAGES_ENABLED= true;
  var CONSENT_REQUIRED      = true;
  var SHOW_TEXT_FIELD       = true;
  var SHOW_EMAIL_FIELD      = true;
  var SHOW_CONSENT          = true;
  var SHOW_HELPER           = true;

  // DOM references filled after init
  var titleEl, textLabelEl, textHelperEl, emailLabelEl, consentLabelEl, consentWrapperEl,
      textFieldWrapper, emailFieldWrapper, msgEl, starsContainer, thanksTitleEl, thanksBodyEl, consentBox;

  // ---------- STYLE CONFIG (runtime-customizable widget skin) ----------
  var DEFAULT_STYLE_CONFIG = {
    size: {
      maxWidth: 420,
      padding: 14,
      borderRadius: 14
    },
    colors: {
      bg: '#0f141c',
      text: '#e8eef7',
      muted: '#9aa4b2',
      line: 'rgba(255,255,255,.08)',
      acc1: '#ff9a1f',
      acc2: '#ffb44d',
      acc3: '#ffd180',
      acc4: '#ffe6b3'
    },
    typography: {
      fontFamily: "'Questrial',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
      baseSize: 15
    },
    shadows: {
      card: '0 12px 28px rgba(0,0,0,.22)'
    },
    stars: {
      size: 36
    },
    text: {
      title:          'Rate your experience',
      textLabel:      'Tell us more (optional)',
      textPlaceholder:'Two lines about your experience…',
      textHelper:     'Max 500 characters.',
      emailLabel:     'Email (optional, for a follow-up if needed)',
      emailPlaceholder:'you@domain.com',
      consentText:    'I consent to processing this feedback and understand it may be used to improve services.',
      submitLabel:    'Send feedback',
      thanksTitle:    'Thanks for your feedback!',
      thanksBody:     'Your response was received.'
    },
    layout: {
      titleAlign:  'center',
      starsAlign:  'center',
      fieldsAlign: 'left',
      buttonAlign: 'stretch',
      msgAlign:    'left'
    },
    button: {
      text:        'Send feedback',
      width:       '100%',
      maxWidth:    null,
      minWidth:    null,
      borderRadius:14,
      border:      null,
      background:  null,
      textColor:   '#221607',
      fontSize:    16,
      fontWeight:  800,
      paddingV:    0.9,
      paddingH:    1.1
    },
    components: {
      showTextField:  true,
      showEmailField: true,
      showConsent:    true,
      showHelperText: true,
      consentRequired:true
    },
    behavior: {
      showErrors:    true,
      textMaxLength: 500
    },
    animation: {
      stars:  true,
      button: true
    }
  };

  // ---------- FONT PRESETS + RESOLVER (accept short names & stacks) ----------
  var FONT_PRESETS = {
    // Sans-serif
    'questrial': "'Questrial',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'inter': "'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'roboto': "'Roboto',system-ui,-apple-system,'Segoe UI','Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'poppins': "'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'lato': "'Lato',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'opensans': "'Open Sans',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'open sans': "'Open Sans',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'nunito': "'Nunito',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'raleway': "'Raleway',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'montserrat': "'Montserrat',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'rubik': "'Rubik',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'manrope': "'Manrope',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'mulish': "'Mulish',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'noto sans': "'Noto Sans',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif",
    'ubuntu': "'Ubuntu',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'dm sans': "'DM Sans',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'space grotesk': "'Space Grotesk',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",

    // Serif
    'playfair display': "'Playfair Display','Times New Roman',Times,serif",
    'merriweather': "'Merriweather','Times New Roman',Times,serif",
    'georgia': "Georgia,'Times New Roman',Times,serif",
    'times': "'Times New Roman',Times,serif",
    'noto serif': "'Noto Serif','Times New Roman',Times,serif",
    'pt serif': "'PT Serif','Times New Roman',Times,serif",
    'dm serif display': "'DM Serif Display','Times New Roman',Times,serif",

    // Mono
    'space mono': "'Space Mono','SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",
    'inconsolata': "'Inconsolata','SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",
    'fira code': "'Fira Code','SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",
    'fira mono': "'Fira Mono','SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",

    // Generic buckets
    'sans': "system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'sans-serif': "system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif",
    'serif': "Georgia,'Times New Roman',Times,serif",
    'mono': "'SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace",
    'monospace': "'SF Mono',Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace"
  };

  function resolveFontFamily(rawName){
    if (typeof rawName !== 'string') return null;
    var trimmed = rawName.trim();
    if (!trimmed) return null;

    // Already a full CSS stack
    if (trimmed.indexOf(',') !== -1) return trimmed;

    var key = trimmed.toLowerCase().replace(/["']/g, '');
    if (FONT_PRESETS[key]) return FONT_PRESETS[key];

    // Heuristics
    if (key.indexOf('mono') !== -1) return FONT_PRESETS['mono'];
    if (key.indexOf('serif') !== -1) return FONT_PRESETS['serif'];
    if (key.indexOf('sans') !== -1) return FONT_PRESETS['sans-serif'];

    // Fallback: custom name + safe stack
    return "'" + trimmed.replace(/'/g, "\\'") + "',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif";
  }

  function isPlainObject(o){
    return !!o && typeof o === 'object' && !Array.isArray(o);
  }

  function deepMerge(base, override){
    var result = {};
    base = base || {};
    override = override || {};
    var k;
    for (k in base){
      if (Object.prototype.hasOwnProperty.call(base, k)){
        result[k] = base[k];
      }
    }
    for (k in override){
      if (Object.prototype.hasOwnProperty.call(override, k)){
        var bv = base[k];
        var ov = override[k];
        if (isPlainObject(bv) && isPlainObject(ov)){
          result[k] = deepMerge(bv, ov);
        } else {
          result[k] = ov;
        }
      }
    }
    return result;
  }

  function applyStyleConfig(userCfg){
    try{
      var cfg = deepMerge(DEFAULT_STYLE_CONFIG, userCfg || {});
      if (!root) return;

      var size     = cfg.size       || {};
      var colors   = cfg.colors     || {};
      var typo     = cfg.typography || {};
      var sh       = cfg.shadows    || {};
      var starsCfg = cfg.stars      || {};
      var textCfg  = cfg.text       || {};
      var layout   = cfg.layout     || {};
      var btnCfg   = cfg.button     || {};
      var compCfg  = cfg.components || {};
      var behavior = cfg.behavior   || {};
      var animCfg  = cfg.animation  || {};

      // geometry
      if (size.maxWidth != null) { root.style.maxWidth = String(size.maxWidth) + 'px'; }
      if (size.padding  != null) { root.style.padding  = String(size.padding)  + 'px'; }

      // colors -> CSS custom properties used in CSS
      if (colors.bg)    { root.style.setProperty('--bg',    colors.bg); }
      if (colors.text)  { root.style.setProperty('--text',  colors.text); }
      if (colors.muted) { root.style.setProperty('--muted', colors.muted); }
      if (colors.line)  { root.style.setProperty('--line',  colors.line); }
      if (colors.acc1)  { root.style.setProperty('--acc-1', colors.acc1); }
      if (colors.acc2)  { root.style.setProperty('--acc-2', colors.acc2); }
      if (colors.acc3)  { root.style.setProperty('--acc-3', colors.acc3); }
      if (colors.acc4)  { root.style.setProperty('--acc-4', colors.acc4); }

      // radius + shadow
      if (size.borderRadius != null){
        root.style.setProperty('--radius', String(size.borderRadius) + 'px');
      }
      if (sh.card){
        root.style.setProperty('--shadow', sh.card);
      }

      // typography (font + size)
      var ff = null;
      if (typo.fontFamily){
        ff = resolveFontFamily(typo.fontFamily);
      }
      if (ff){
        root.style.setProperty('--rf-font', ff);
        root.style.fontFamily = ff;
      }
      if (typo.baseSize != null){
        root.style.fontSize = String(typo.baseSize) + 'px';
      }

      // stars size
      if (starsCfg.size != null){
        var px = String(starsCfg.size) + 'px';
        var btns = root.querySelectorAll('.star');
        for (var i = 0; i < btns.length; i++){
          btns[i].style.width  = px;
          btns[i].style.height = px;
        }
      }

      // Text content overrides
      if (titleEl && textCfg.title != null){
        titleEl.textContent = String(textCfg.title);
      }
      if (textLabelEl && textCfg.textLabel != null){
        textLabelEl.textContent = String(textCfg.textLabel);
      }
      if (textEl && textCfg.textPlaceholder != null){
        textEl.placeholder = String(textCfg.textPlaceholder);
      }
      if (textHelperEl && textCfg.textHelper != null){
        textHelperEl.textContent = String(textCfg.textHelper);
      }
      if (emailLabelEl && textCfg.emailLabel != null){
        emailLabelEl.textContent = String(textCfg.emailLabel);
      }
      if (emailEl && textCfg.emailPlaceholder != null){
        emailEl.placeholder = String(textCfg.emailPlaceholder);
      }
      if (consentLabelEl && textCfg.consentText != null){
        consentLabelEl.textContent = String(textCfg.consentText);
      }
      if (send && textCfg.submitLabel != null){
        send.textContent = String(textCfg.submitLabel);
      }
      if (thanksTitleEl && textCfg.thanksTitle != null){
        thanksTitleEl.textContent = String(textCfg.thanksTitle);
      }
      if (thanksBodyEl && textCfg.thanksBody != null){
        thanksBodyEl.textContent = String(textCfg.thanksBody);
      }

      // Behavior (errors + text length)
      if (behavior && typeof behavior === 'object'){
        if (behavior.showErrors === false){
          ERROR_MESSAGES_ENABLED = false;
        } else if (behavior.showErrors === true){
          ERROR_MESSAGES_ENABLED = true;
        }

        if (behavior.textMaxLength != null){
          var max = parseInt(behavior.textMaxLength, 10);
          if (Number.isFinite(max) && max > 0){
            TEXT_MAX_LENGTH = max;
            if (textEl){ textEl.maxLength = max; }
            if (textHelperEl && textCfg.textHelper == null){
              textHelperEl.textContent = 'Max ' + max + ' characters.';
            }
          }
        }
      }

      // Components (visibility + consent requirement)
      if (compCfg && typeof compCfg === 'object'){
        if (typeof compCfg.showTextField === 'boolean'){
          SHOW_TEXT_FIELD = compCfg.showTextField;
        }
        if (typeof compCfg.showEmailField === 'boolean'){
          SHOW_EMAIL_FIELD = compCfg.showEmailField;
        }
        if (typeof compCfg.showConsent === 'boolean'){
          SHOW_CONSENT = compCfg.showConsent;
        }
        if (typeof compCfg.showHelperText === 'boolean'){
          SHOW_HELPER = compCfg.showHelperText;
        }
        if (typeof compCfg.consentRequired === 'boolean'){
          CONSENT_REQUIRED = compCfg.consentRequired;
        } else {
          CONSENT_REQUIRED = SHOW_CONSENT;
        }
      }

      if (textFieldWrapper){
        textFieldWrapper.style.display = SHOW_TEXT_FIELD ? '' : 'none';
      }
      if (emailFieldWrapper){
        emailFieldWrapper.style.display = SHOW_EMAIL_FIELD ? '' : 'none';
      }
      if (consentWrapperEl){
        consentWrapperEl.style.display = SHOW_CONSENT ? '' : 'none';
      }
      if (textHelperEl){
        textHelperEl.style.display = SHOW_HELPER ? '' : 'none';
      }

      // Layout / alignment
      if (layout.titleAlign && titleEl){
        titleEl.style.textAlign = String(layout.titleAlign);
      }
      if (layout.starsAlign && starsContainer){
        var ja = String(layout.starsAlign).toLowerCase();
        var jc = 'center';
        if (ja === 'left' || ja === 'flex-start') jc = 'flex-start';
        else if (ja === 'right' || ja === 'flex-end') jc = 'flex-end';
        else if (ja === 'space-between') jc = 'space-between';
        starsContainer.style.justifyContent = jc;
      }
      if (layout.fieldsAlign){
        var ta = String(layout.fieldsAlign);
        if (textLabelEl)  textLabelEl.style.textAlign  = ta;
        if (emailLabelEl) emailLabelEl.style.textAlign = ta;
        if (consentLabelEl) consentLabelEl.style.textAlign = ta;
        if (textEl)  textEl.style.textAlign  = ta;
        if (emailEl) emailEl.style.textAlign = ta;
      }
      if (layout.msgAlign && msgEl){
        msgEl.style.textAlign = String(layout.msgAlign);
      }
      if (layout.buttonAlign && send){
        var ba = String(layout.buttonAlign).toLowerCase();
        if (ba === 'left'){
          send.style.marginLeft = '0';
          send.style.marginRight = 'auto';
        } else if (ba === 'right'){
          send.style.marginLeft = 'auto';
          send.style.marginRight = '0';
        } else if (ba === 'center'){
          send.style.marginLeft = 'auto';
          send.style.marginRight = 'auto';
        } else {
          send.style.marginLeft = '0';
          send.style.marginRight = '0';
        }
      }

      // Button styling
      if (send && btnCfg){
        if (btnCfg.text != null){
          send.textContent = String(btnCfg.text);
        }
        if (btnCfg.width != null){
          var w = btnCfg.width;
          send.style.width = (typeof w === 'number') ? (w + 'px') : String(w);
        }
        if (btnCfg.minWidth != null){
          var mw = btnCfg.minWidth;
          send.style.minWidth = (typeof mw === 'number') ? (mw + 'px') : String(mw);
        }
        if (btnCfg.maxWidth != null){
          var xw = btnCfg.maxWidth;
          send.style.maxWidth = (typeof xw === 'number') ? (xw + 'px') : String(xw);
        }
        if (btnCfg.borderRadius != null){
          send.style.borderRadius = String(btnCfg.borderRadius) + 'px';
        }
        if (btnCfg.border != null){
          send.style.border = String(btnCfg.border);
        }
        if (btnCfg.background != null){
          send.style.background = String(btnCfg.background);
        }
        if (btnCfg.textColor != null){
          send.style.color = String(btnCfg.textColor);
        }
        if (btnCfg.fontSize != null){
          var bfs = btnCfg.fontSize;
          send.style.fontSize = (typeof bfs === 'number') ? (bfs + 'px') : String(bfs);
        }
        if (btnCfg.fontWeight != null){
          send.style.fontWeight = String(btnCfg.fontWeight);
        }
        var pv = btnCfg.paddingV;
        var ph = btnCfg.paddingH;
        if (pv != null || ph != null){
          if (pv == null){ pv = DEFAULT_STYLE_CONFIG.button.paddingV; }
          if (ph == null){ ph = DEFAULT_STYLE_CONFIG.button.paddingH; }
          send.style.padding = String(pv) + 'rem ' + String(ph) + 'rem';
        }
      }

      // Animations
      if (animCfg && typeof animCfg === 'object'){
        if (animCfg.stars === false){
          root.classList.add('rf-no-star-anim');
        } else {
          root.classList.remove('rf-no-star-anim');
        }
        if (animCfg.button === false){
          root.classList.add('rf-no-cta-anim');
        } else {
          root.classList.remove('rf-no-cta-anim');
        }
      }

      if (typeof postSize === 'function'){
        try{ postSize(); }catch(_){}
      }
    }catch(e){
      console.warn('applyStyleConfig failed', e);
    }
  }

  function safeShow(t, ok){
    try{
      var msg = msgEl || (root && root.querySelector('#rf-msg'));
      if(!msg) return;

      if (!ok && !ERROR_MESSAGES_ENABLED){
        msg.textContent = '';
        return;
      }

      var frost = root.classList.contains('theme-frost');
      msg.textContent = t || '';
      msg.style.color = ok ? (frost ? '#0a7a4b' : '#a8f0c8') : (frost ? '#b91c1c' : '#ffbdbd');
    }catch(e){}
  }
  function normHost(h){
    return String(h||'')
      .replace(/^https?:\/\//, '')
      .replace(/^www\./, '')
      .split('/')[0]
      .toLowerCase();
  }
  function canon(h){
    h = normHost(h);
    if(!h) return '';
    if (h.endsWith('filesusr.com')) {
      var first = h.split('.')[0] || '';
      var decoded = first.replace(/-/g,'.').replace(/^www\./,'');
      return decoded.toLowerCase();
    }
    return h.replace(/^www\./,'');
  }

  try{
    // Params
    var p = new URLSearchParams(location.search);
    var theme = (p.get('theme')||'gold').toLowerCase();
    var eid   = (p.get('eid')||('rf-'+Math.random().toString(36).slice(2)));
    var wid   = (p.get('wid')||'').trim();  // REQUIRED
    var viewer= canon(p.get('viewer')||''); // canonicalized

    // Optional display/company (ignored by server)
    var companyId = (p.get('company')||'').trim();
    if(!companyId){
      try{
        var ref = document.referrer||'';
        if(ref){
          var host = new URL(ref).hostname.replace(/^www\./,'');
          if(host) companyId = host;
        }
      }catch(e){}
    }
    if(!companyId){ companyId = 'PUBLIC'; }

    // Theme selection
    var THEMES = ['gold','slate','emerald','amethyst','frost','copper','sapphire','coral','graphite'];
    var n = parseInt(theme,10); if(Number.isFinite(n) && n>=1 && n<=THEMES.length) theme = THEMES[n-1];
    if(THEMES.indexOf(theme)===-1) theme='gold';
    root.classList.add('theme-'+theme);

    // Elements
    var form   = root.querySelector('#rf-form');
    var done   = root.querySelector('#rf-thanks');
    var send   = root.querySelector('#rf-send');
    var textEl = root.querySelector('#rf-text');
    var emailEl= root.querySelector('#rf-email');

    titleEl          = root.querySelector('.title');
    textLabelEl      = root.querySelector('label[for="rf-text"]');
    textHelperEl     = root.querySelector('.helper');
    emailLabelEl     = root.querySelector('label[for="rf-email"]');
    consentWrapperEl = root.querySelector('.consent');
    consentLabelEl   = consentWrapperEl ? consentWrapperEl.querySelector('span') : null;
    textFieldWrapper = textEl ? textEl.parentElement : null;
    emailFieldWrapper= emailEl ? emailEl.parentElement : null;
    msgEl            = root.querySelector('#rf-msg');
    starsContainer   = root.querySelector('#rf-stars');
    thanksTitleEl    = root.querySelector('#rf-thanks h3');
    thanksBodyEl     = root.querySelector('#rf-thanks p');
    consentBox       = root.querySelector('#rf-consent');

    // Stars
    var stars = Array.prototype.slice.call(root.querySelectorAll('.star'));
    var rating = 0;
    function paintActive(n){ stars.forEach(function(b,i){ b.classList.toggle('active', i<n); b.classList.remove('preview'); }); }
    function paintPreview(n){ stars.forEach(function(b,i){ b.classList.toggle('preview', i<n); }); }

    stars.forEach(function(btn){
      btn.addEventListener('mouseover', function(){ paintPreview(Number(btn.dataset.v)); });
      btn.addEventListener('mouseout',  function(){ paintPreview(0); });
      btn.addEventListener('click', function(){
        rating = Number(btn.dataset.v);
        paintActive(rating);
        btn.classList.add('pop');
        btn.addEventListener('animationend', function(){ btn.classList.remove('pop'); }, { once:true });
      });
      btn.addEventListener('keydown', function(e){
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          rating = Number(btn.dataset.v);
          paintActive(rating);
        }
      });
    });
    paintActive(0);

    textEl.addEventListener('input', function(){
      if(textEl.value.length > TEXT_MAX_LENGTH){
        textEl.value = textEl.value.slice(0, TEXT_MAX_LENGTH);
      }
    });

    // ---- NEW: clientId + clientHash ----
    function getCID(){
      try{
        const key = 'rf.cid.' + (wid||'');
        let cid = localStorage.getItem(key);
        if (!cid) {
          cid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('c_' + Math.random().toString(36).slice(2) + Date.now().toString(36));
          localStorage.setItem(key, cid);
        }
        try { document.cookie = 'rf_cid=' + encodeURIComponent(cid) + '; path=/; max-age='+(3600*24*400)+'; SameSite=None; Secure'; } catch(_){}
        return cid;
      }catch(_){ return 'cid_'+Math.random().toString(36).slice(2); }
    }
    function getCH() {
      try {
        const parts = [
          navigator.userAgent || '',
          navigator.language || '',
          String(screen && screen.width)+'x'+String(screen && screen.height),
          String(Intl && Intl.DateTimeFormat().resolvedOptions().timeZone || '')
        ].join('|');
        let h=0; for (let i=0;i<parts.length;i++){ h=((h<<5)-h)+parts.charCodeAt(i); h|=0; }
        return 'h'+(h>>>0).toString(16);
      } catch(_){ return ''; }
    }
    var clientId   = getCID();
    var clientHash = getCH();

    // Endpoint(s)
    var ENDPOINT = 'https://sandermh7.wixsite.com/my-site-1/_functions/feedback';
    var VERIFY_ENDPOINT = 'https://sandermh7.wixsite.com/my-site-1/_functions/verify_install';
    function show(text, ok){ safeShow(text, ok===true); }

    // ---------- NEW: one-shot verification beacon (throttled) ----------
    var VERIFY_THROTTLE_MS = 12 * 60 * 60 * 1000; // 12h
    var VK = function(){ return 'rf.lastVerify.' + (wid||''); };
    function beaconVerify(force){
      try{
        var last = localStorage.getItem(VK());
        if (!force && last && (Date.now() - Number(last)) < VERIFY_THROTTLE_MS) return;
        var originHost = '';
        try { originHost = new URL(document.referrer || '').hostname.replace(/^www\./,''); } catch(e){}
        var payload = { widgetId: wid, viewer: viewer || '', originHost: originHost || '', mode:'beacon' };
        fetch(VERIFY_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
          .then(function(r){ if(r && r.ok){ try{ localStorage.setItem(VK(), String(Date.now())); }catch(e){} } })
          .catch(function(){});
      } catch(_){}
    }
    // fire once (non-blocking)
    try { setTimeout(function(){ beaconVerify(false); }, 0); } catch(_){}

    // Optional: accept a postMessage to force re-verify OR apply skin (e.g., from embed shell)
    window.addEventListener('message', function(ev){
      try{
        var m = ev && ev.data || {};
        if (!m) return;

        if (m.type === 'rf-verify' && (!m.wid || m.wid === wid)) {
          beaconVerify(true);
          return;
        }

        if (m.type === 'RF_WIDGET_CONFIG' && (!m.wid || m.wid === wid)) {
          applyStyleConfig(m.config || {});
          return;
        }
      }catch(_){}
    });

    // ---------- COOLDOWN UI ----------
    var LOCAL_COOLDOWN_MS = 5 * 60 * 1000; // must match server during testing
    var CD_KEY = function(){ return 'rf.nextAllowed.' + (wid||''); };
    var cdTimer = null;
    function fmt(sec){
      sec = Math.max(0, Math.floor(sec));
      var m = Math.floor(sec/60), s = sec%60;
      return String(m).padStart(1,'0') + ':' + String(s).padStart(2,'0');
    }
    function startCooldown(untilIso){
      try{
        var until = new Date(untilIso);
        var endMs = until.getTime();
        if (!isFinite(endMs)) return;
        localStorage.setItem(CD_KEY(), until.toISOString());
        if (cdTimer) clearInterval(cdTimer);
        send.disabled = true;
        cdTimer = setInterval(function(){
          var left = Math.ceil((endMs - Date.now())/1000);
          if (left > 0) {
            show('Please wait ' + fmt(left) + ' before sending another review.', false);
          } else {
            clearInterval(cdTimer); cdTimer=null;
            localStorage.removeItem(CD_KEY());
            send.disabled = false;
            show('', true);
          }
        }, 1000);
      }catch(_){}
    }
    (function bootCooldown(){
      try{
        var iso = localStorage.getItem(CD_KEY());
        if (!iso) return;
        var endMs = new Date(iso).getTime();
        if (!isFinite(endMs)) { localStorage.removeItem(CD_KEY()); return; }
        var left = Math.ceil((endMs - Date.now())/1000);
        if (left > 0) startCooldown(iso); else localStorage.removeItem(CD_KEY());
      }catch(_){}
    })();

    async function submit(){
      try{
        if(!wid){ show('Missing widget id.', false); return; }
        if(rating < 1){ show('Please select 1 to 5 stars.', false); return; }

        var consentNode = consentBox || root.querySelector('#rf-consent');
        if (CONSENT_REQUIRED && consentNode && !consentNode.checked){
          show('Please accept the consent.', false);
          return;
        }

        if(root.querySelector('#rf-website').value){
          form.classList.add('hide'); done.classList.remove('hide'); return;
        }

        // referrer captured for analytics only
        var originHost = '';
        try { originHost = new URL(document.referrer || '').hostname.replace(/^www\./,''); } catch(e) {}

        var payload = {
          widgetId: wid,
          companyId: companyId,    // optional; ignored server-side
          originHost: originHost,
          viewer: viewer || '',
          clientId: clientId,
          clientHash: clientHash,
          scoreStars: rating,
          text: (textEl.value || '').trim(),
          contact: (emailEl.value || '').trim() ? { email: emailEl.value.trim() } : null,
          consent: true,
          channel: 'widget',
          eventId: (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())
        };

        send.disabled = true; show('Sending…', true);

        var res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        var okCT = (res.headers.get('content-type')||'').toLowerCase().includes('application/json');
        var j = okCT ? await res.json() : {};
        if(res.ok && j.ok){
          form.classList.add('hide'); done.classList.remove('hide'); show('', true);
          // Start local cooldown (server hint preferred)
          var until = j.nextAllowedAt || (j.retryAfterSec ? new Date(Date.now()+Number(j.retryAfterSec)*1000).toISOString() : new Date(Date.now()+LOCAL_COOLDOWN_MS).toISOString());
          startCooldown(until);
        } else {
          if (res.status===429 || j.cooldown===true) {
            var ra = parseInt(res.headers.get('Retry-After')||'',10);
            var until = j.nextAllowedAt || '';
            if (!until && ra>0) until = new Date(Date.now()+ra*1000).toISOString();
            if (!until) until = new Date(Date.now()+LOCAL_COOLDOWN_MS).toISOString();
            startCooldown(until);
            var leftTxt = (ra && ra>0) ? (' ' + fmt(ra)) : '';
            show('Please wait before sending another review.' + leftTxt, false);
          } else {
            var err = (j && j.error) || 'Could not send right now. Please try again.';
            if (/limit/i.test(err) && j.nextReset) {
              show('Limit reached. Try again after ' + new Date(j.nextReset).toLocaleString() + '.', false);
            } else {
              show(err, false);
            }
          }
        }
      }catch(e){
        console.error(e);
        // If we have a stored cooldown end, show that instead of a generic network error
        try{
          var iso = localStorage.getItem(CD_KEY());
          if (iso) { startCooldown(iso); return; }
        }catch(_){}
        show('Network error—please try again.', false);
      }finally{
        send.disabled = false;
      }
    }
    send.addEventListener('click', submit);

    // Auto-resize to parent
    function postSize(){
      try{
        var h = document.documentElement.scrollHeight || document.body.scrollHeight || root.offsetHeight || 460;
        parent.postMessage({ type:'rf-size', id:eid, h:h }, '*');
      }catch(e){}
    }
    new ResizeObserver(postSize).observe(document.body);
    window.addEventListener('load', postSize);
    setTimeout(postSize, 250);

    if(!wid){ show('Missing widget id. Add ?wid=YOUR_ID to the URL.', false); }

  }catch(err){
    console.error('Widget init error:', err);
    try{
      var msg = document.createElement('p');
      msg.className = 'msg';
      msg.textContent = 'Widget failed to initialize.';
      var formEl = document.getElementById('rf-form');
      if(formEl) formEl.appendChild(msg);
    }catch(e){}
  }
})();
</script>
</body>
</html>
